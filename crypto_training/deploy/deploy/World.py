# area descriptions

area0_desc = """The road curves and gives way to marshland. You tread by one careful
step after another, focused so much on your footings that you only notice the
lizardman when he starts talking to you. "Hello, I am in the Enformation
Commerce. We two must have things to trade." He needs help with math to break
some encrypted messages.
"""

area1_desc = """As you journey on, the weather suddenly turns and you realize that a storm is 
imminent. Luckily you spot a big oak tree and manage to find shelter under its
canopy just in time. While the hail falls, you have time to contemplate the 
lectures by your old mentors. Perhaps the answers won't elude you this time?
"""

area2_desc = """Passing by a small town, you meet a scholar, and you two walk together for a
while. He rambles about a manuscript that, he says, claims the preposterous 
idea that one equation could nail down two variables simultaneously. Since 
you show enough interest, he lets you copy a few puzzles from the book.
"""

area3_desc = """Welcome! This is a small training ground for recruits in Cryptography.

Yeah, crypto *is* cool. But don't let people fool you, it's not about those 
neat little games around scrambling letters and various encodings. Instead, 
crypto is really about math. So your ability to solve crypto problems will 
mainly be limited by how much math you know, or can handle ;), and how
efficiently you can compute.

Here you will find a bunch of math problems relevant for crypto. Some are
basic, others less so. For those with experience, solving these is automatic,
like muscle memory. Let's see how well *you* can do it on your computer.

Each area has one problem type, starting from Level 1, going up to Level 3.
If you solve a particular level, you get a flag for it. Answers can be
entered in the text area below, e.g., to reply 2 and 3, you would type 
"ans 2 3 [ENTER]". Try "help" to list the available commands.

*** Note: - this is a stateless server
***       - if you close or reload the window, all progress will be lost
***       - so back up solutions offline (your problems do not randomize)
***       - wrong answers will trigger a per-*team* rate limiter
"""

area4_desc = """As dusk falls you make camp at a logging area. There are tree stumps
everywhere, some truly gigantic ones too. You are just about to fall asleep
when you hear footsteps - one of the fellers came back for his axe. He moves
sluggishly as if his limbs were made of lead, totally obliviously to your
presence. As he leaves you catch him grumbling about how hard this line of 
work is. Your eyes close and you dream, of something quite peculiar...
"""

area5_desc = """At last, the laboratory! Scores of exotic magical objects occupy your view,
prime among those is the spellbook of the Great Wizard. It would be so *easy*
to just take it. Alas, with each and every item enveloped by a protective
aura, your hands phase through as if everything were made of air. You realize
that, unless you can harness SHA 256 and bend it to your will, you are going
to leave empty handed... There is a faint but distinct trace in the room of
how the protections were cast (http://[THIS_SERVER]/sha256_recipe). 
"""

area6_desc = """As you trek through dense forest, you notice a giant snake curled up in the
center of a clearing ahead. You freeze, and try to tip-toe back, but it's too
late. "Count your blessssingsss, human, for I'm not hungry... thisss time.
Sssspeaking of counting... I can tell you sssecrets if you demonssstrate you
are capable.
"""

area7_desc = """You stop by at a small village to quench your thirst. In its pub you find a
group of peasants, who are in the middle of a heated argument. As you sip your 
drink, you cannot help listening... is it about.. numbers?? One of them
points at you and asks, "Traveler, which of us is right? Ol' Jeff says he has
a clever way to make numbers small but we think that's just bollocks."
"""

area8_desc = """Higher up on the hillside you come across a small house with a tidy garden.
An elderly rabbit lady in a rocking chair is observing you, while she nibbles
on some sort of brown root (carrot maybe?). "Have some, my dear" she says,
"great for vision." You oblige, and indeed, as if finer distinctions started
to materialize in things. "Now we just need to calibrate the dose," says the
rabbit and gives you something colorful to peer into.
"""

area9_desc = """You are inside the wizard's tower! It looks surpringly empty... You find a small
chest that appears to be magically sealed, and some research notes about the
wonders of Secure Hash Algorithm 256. There is a portal shimmering on the
north wall. Just as you figure out what must be the passcode to the chest,
a shrill voice yells out of nowhere "We are tracking you, Intruder!"
"""

area10_desc = """It becomes obvious that the path is a dead end but you finish the hike for the
splendid view. There is already a figure sitting up there admiring it too. A
battle-hardened warrior by the look of him. "Goodday, stranger, what brings 
you to the middle of nowhere?" You exchange a few words with long stretches
of silence in between, both of you enjoying the peace of the place. 
Eventually the warrior gets up and bids farewell. 
"""

area11_desc = """You are at a signpost, trying to figure out which path will get you through
the forest. While you are contemplating, another traveller arrives. The fellow
seems to know his way, so you decide to ask him. He gestures about (as if
asking a question?) but you hear nothing. It is then that you realize that he
cannot speak. You seem crestfallen but the traveller's face brightens - he
takes out parchment and ink from his bag and begins to write... something
that looks gibberish to you. Still, you do notice some familiarity in those
symbols...
"""

area12_desc = """You see an inn and decide that you deserve to splurge some on a good meal and
a comfy bed. The room is tidy and clean but you do notice certain little
visitors... mice. Fear not, the innkeeper's cat comes eagerly to your rescue.
But whenever it tries to catch one, the mouse quickly disappears in one of
many mouseholes in the room. With this game going on and on for minutes, you
swear those mice must be playing with the cat. Interesting, you think, there
must be a smarter way to capture small creatures...
"""

area13_desc = """To the north is a narrow bridge that leads to the tower of the Greatest Crypto
Wizard of the land. Or, what remained of the bridge... Crossing the chasm 
below is surely impossible. A sign by the bridge says "You shall *not* pass."
"""

area14_desc = """You make camp by a delapidated building that must have been a shrine in its
better days. As the rays of the setting sun illuminate the walls, you notice a
crevice with a piece of parchment tucked inside... a treasure map! Though you
cannot quite make out which direction is east or west, and north or south, on
the map, this *could* be payday - provided you figure out the right number of
steps to take.
"""

area15_desc = """A huge basin opens up to your view, wide swathes of farmland surrounded by a
ring of mountains in the distance. In the cool breeze your thoughts roam free
and wild... what if those mountains are really teeth, devouring a giant wafer
(the fields), and you are just an ant experiencing it all up close? You savor
each possibility conjured up by your mind - one can never know when some of
it comes handy.
"""


default_areas = [
         area0_desc,  
         area1_desc,   #1
         area2_desc,   #2
         area3_desc,   #3
         area4_desc,
         area5_desc,
         area6_desc,   #6
         area7_desc,   #7
         area8_desc,
         area9_desc,
         area10_desc,
         area11_desc,
         area12_desc,
         area13_desc,
         area14_desc,
         area15_desc ]  #15




# note this is map[y][x]   (x horizontal, y vertical)
default_map = ( "*********",
                "*X X X X*",
                "* ***   *",
                "*X*L*X X*",
                "* * *** *",     # --> E
                "*X*T*X*X*",
                "* *** * *",     # |
                "*X X X X*",     # v  S
                "*********" )

default_start = (3, 0)

basedirs = { "n": (0, -1),  "e": (1, 0),  "s": (0, 1),  "w": (-1, 0) }



class World:

   def __init__(self, worldmap = None, entry = None, areas = None):
      if worldmap == None:
         worldmap = default_map
      if entry == None:
         entry = default_start
      self.parseMap(worldmap)           # make exits dictionaries
      self.start = self.locTo1D(entry)  # drop-off location on entry to world
      if areas == None:
         areas = default_areas
      assert len(areas) >= self.roomCount(), "too few area descriptions"
      self.descriptions = areas

   def locTo1D(self, xy):  return xy[0] + self.nx * xy[1]  # horizontal scan

   def roomCount(self):  return self.nx * self.ny

   def parseMap(self, mp):
      # dimensions
      nx = (len(mp[0]) - 1) //2 
      ny = (len(mp) - 1) // 2
      self.nx, self.ny = nx, ny
      # build True/False exits array - exits: n, e, s, w
      ex = [ {} for loc in range(nx * ny) ]
      for i in range(nx):
         for j in range(ny):
            x0, y0 = 2 * i + 1, 2 * j + 1
            loc0 = self.locTo1D((i, j))
            c = mp[y0][x0]
            if   c == 'L':  self.lab   = loc0
            elif c == 'T':  self.tower = loc0
            else:  
               assert c == 'X', "wrong map format (X)"
            for name, (dx,dy) in basedirs.items():
               ex[loc0][name] = (mp[y0 + dy][x0 + dx] == ' ')
      self.exits = ex

   def move(self, currentLoc, direction):
      ex = self.exits[currentLoc].get(direction)
      if ex == False or ex == None: return currentLoc    # if new = current, move failed
      newLoc = currentLoc + self.locTo1D(basedirs[direction])
      return newLoc

   def isOffMap(self, location):
      return location < 0 or location >= self.roomCount()

   def describe(self, location):
      return self.descriptions[location]


if __name__ == "__main__":

   print( "using default world" )
   #world = World(default_map, (3, 0))
   world = World()
   print( f"{world.nx} x {world.ny}" )
   print( f"starting at location {world.start}" )
   print( [ ( dr, world.move(world.start, dr) )  for dr in list(basedirs) + ["f"] ] )
 
